# Document Share & Copy System - Component Guide

## Overview

This directory contains the implementation of the document sharing and copying system for Oncore.

## Components

### Service Files

#### Mobile Service: `lib/services/document_share_service.dart`
The core service for document operations on Flutter/mobile.

**Key Methods:**
- `generateShareableLink()` - Generate signed URL
- `copyLinkToClipboard()` - Copy URL to clipboard
- `shareDocument()` - Open native share sheet
- `copyMetadataToClipboard()` - Copy document metadata
- `shareMultipleDocuments()` - Share batch of documents

**Dependencies:**
- Supabase for signed URL generation
- share_plus for native sharing
- Flutter clipboard services

**Usage:**
```dart
final service = DocumentShareService(supabase: supabase);
await service.shareDocument(
  document: doc,
  showTitle: 'Concert',
  context: context,
);
```

#### Web Service: `lib/services/document-share.ts`
Equivalent TypeScript service for web client.

**Key Functions:**
- `copyToClipboard()` - Cross-browser clipboard
- `copyDocumentLink()` - Copy signed URL
- `shareDocument()` - Web Share API + fallback
- `downloadDocument()` - Browser download
- `shareMultipleDocuments()` - Batch share

**Browser Support:**
- Modern: Full Web Share API support
- Older: Falls back to clipboard copy
- All: Download support

**Usage:**
```typescript
const success = await copyDocumentLink(document);
if (success) {
  toast.success('Link copied!');
}
```

### UI Components

#### Mobile Component: `screens/show_day/widgets/documents_screen.dart`
Updated documents viewer with share/copy integration.

**Changes:**
- Added `_copyDocumentLink()` method
- Added `_shareDocument()` method
- Updated action buttons to use new methods
- Removed "coming soon" placeholders

**UI Elements:**
- Delete button (existing)
- Copy button (NEW)
- Share button (NEW)

#### Web Component: `components/documents/DocumentShareActions.tsx`
Reusable React component for document actions.

**Features:**
- Copy button
- Share button
- Download button
- Loading states
- Size variants (sm, md)
- Success callbacks

**Props:**
```tsx
interface DocumentShareActionsProps {
  document: DocumentInfo;
  showTitle: string;
  onCopySuccess?: () => void;
  onShareSuccess?: () => void;
  onDownloadSuccess?: () => void;
  variant?: "inline" | "dropdown";
  showDownload?: boolean;
  size?: "sm" | "md";
}
```

**Usage:**
```tsx
<DocumentShareActions
  document={file}
  showTitle={show.title}
  size="sm"
  onCopySuccess={() => toast('Copied!')}
/>
```

## Integration Guide

### For Mobile
Already integrated in DocumentsScreen. No additional steps needed.

### For Web
To integrate into DocumentsPanel:

1. Import the component:
```tsx
import { DocumentShareActions } from "@/components/documents/DocumentShareActions";
```

2. Replace file action buttons with:
```tsx
<DocumentShareActions
  document={{
    id: file.id,
    storagePath: file.storage_path,
    originalName: file.original_name,
    contentType: file.content_type,
    sizeBytes: file.size_bytes,
  }}
  showTitle={showTitle}
  size="sm"
/>
```

See `docs/DOCUMENT_SHARE_INTEGRATION.md` for detailed steps.

## Architecture

```
┌─────────────────────────────────────┐
│       UI Components                 │
│  (documents_screen.dart / .tsx)     │
└──────────────────┬──────────────────┘
                   │
┌──────────────────▼──────────────────┐
│    Service Classes/Functions        │
│ (document_share_service.dart / .ts) │
└──────────────────┬──────────────────┘
                   │
┌──────────────────▼──────────────────┐
│   Infrastructure (Supabase, APIs)   │
│  (Storage, Clipboard, Web Share)    │
└─────────────────────────────────────┘
```

## Testing

### Mobile Testing

**Copy Link:**
1. Open document viewer
2. Tap copy button
3. See "Link copied to clipboard" toast
4. Paste in Notes app
5. Should be valid HTTPS URL

**Share:**
1. Open document viewer
2. Tap share button
3. Select destination (Email, Messages, etc.)
4. Document info appears in share view
5. Send to verify

### Web Testing

**Copy:**
1. Hover document
2. Click copy button
3. Paste in address bar
4. Should load document preview

**Share:**
1. Click share button
2. Mobile: Native sheet opens
3. Desktop: Falls back to copy
4. Message includes document name and URL

**Download:**
1. Click download button
2. File downloads to Downloads folder
3. Filename matches original

## Security Considerations

✅ **Signed URLs**
- Generated by Supabase
- 1-hour expiry (customizable)
- Tamper-proof

✅ **Access Control**
- RLS policies apply
- No direct file exposure
- URL-only sharing

✅ **No Tracking (Yet)**
- Future RPC can add analytics
- Currently anonymous shares

## Performance

| Operation | Time | Notes |
|-----------|------|-------|
| Generate URL | 100-200ms | Network call |
| Copy to clipboard | <1ms | Local |
| Share sheet | Instant | Native |
| Download | Depends | File size |

## Future Enhancements

1. **Persistent Links**
   - Database-tracked links
   - Custom expiry
   - Access controls

2. **Share Analytics**
   - Track who shared
   - When and what
   - Via which method

3. **Feedback System**
   - Request comments
   - Mark as reviewed
   - Notification system

4. **Integration**
   - Email templates
   - QR codes
   - Team notifications

## Troubleshooting

### "Failed to generate shareable link"
- Check Supabase storage bucket permissions
- Verify document storage path
- Check network connectivity

### Copy not working
- Mobile: Check iOS/Android permissions
- Web: Must be HTTPS
- Check Clipboard API availability

### Share not working
- Mobile: Check share_plus integration
- Web: Some browsers have restrictions
- Try copy as fallback

## Code Organization

```
mobile/
├── lib/
│   ├── services/
│   │   └── document_share_service.dart ← Service
│   ├── screens/show_day/widgets/
│   │   └── documents_screen.dart ← UI
│   └── models/
│       └── show_day.dart ← DocumentInfo model

client/
├── lib/services/
│   └── document-share.ts ← Service
└── components/documents/
    └── DocumentShareActions.tsx ← Component

docs/
├── DOCUMENT_SHARE_SYSTEM.md ← Architecture
├── DOCUMENT_SHARE_INTEGRATION.md ← How to integrate
├── DOCUMENT_SHARE_QUICKSTART.md ← Developer guide
└── SHARE_COPY_IMPLEMENTATION_COMPLETE.md ← Project summary
```

## API Reference

### Mobile Service

```dart
class DocumentShareService {
  // Get signed URL
  Future<String?> generateShareableLink({
    required String storagePath,
    int expirySeconds = 3600,
  })

  // Core operations
  Future<bool> copyLinkToClipboard({ ... })
  Future<bool> shareDocument({ ... })
  Future<bool> copyMetadataToClipboard({ ... })
  
  // Batch operations
  Future<int> shareMultipleDocuments({ ... })
  
  // Utility
  Map<String, dynamic> getDocumentInfo(DocumentInfo document)
}
```

### Web Service

```typescript
// Core operations
export async function copyToClipboard(text: string): Promise<boolean>
export async function copyDocumentLink(document: DocumentInfo): Promise<boolean>
export async function shareDocument(document: DocumentInfo, showTitle: string): Promise<boolean>
export async function downloadDocument(document: DocumentInfo): Promise<boolean>

// Batch operations
export async function shareMultipleDocuments(documents: DocumentInfo[], showTitle: string): Promise<number>
export async function copyMultipleDocumentLinks(documents: DocumentInfo[]): Promise<number>

// Utilities
export function formatFileSize(bytes: number | null): string
export function isPdfDocument(contentType: string | null): boolean
export function isImageDocument(contentType: string | null): boolean
export function canPreviewDocument(contentType: string | null): boolean
```

## Dependencies

### Mobile
```yaml
share_plus: ^7.2.0  # Native sharing
```

Existing dependencies used:
- flutter/services (Clipboard)
- supabase_flutter (Storage)
- app_toast (Notifications)

### Web
No new dependencies required. Uses:
- Browser APIs (Clipboard, Web Share)
- Existing UI components (@/components/ui/button)
- Logger service (@/lib/logger)

## Contact & Support

For questions or issues:
1. Check docs in `docs/` folder
2. Review service code comments
3. See quick-start guide
4. Check troubleshooting section

---

**Last Updated**: December 11, 2025
**Status**: ✅ Complete & Ready
**Version**: 1.0.0
